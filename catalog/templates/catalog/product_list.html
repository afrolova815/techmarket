{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="catalog-layout">
  <aside class="filters-sidebar">
    <h2 class="filters-title">Фильтры</h2>
    <details class="filter-group {% if active_category_slugs %}has-active{% endif %}" {% if active_category_slugs %}open{% endif %}>
      <summary>Категории</summary>
      <ul class="filter-list">
        {% for f in facet_categories %}
        <li class="filter-item {% if f.active %}active{% endif %}">
          <label>
            <input type="checkbox" class="filter-checkbox" data-group="categories" value="{{ f.slug }}" {% if f.active %}checked{% endif %}>
            <span class="filter-name">{{ f.name }}</span>
            <span class="filter-count">({{ f.count }})</span>
          </label>
        </li>
        {% endfor %}
      </ul>
    </details>

    <details class="filter-group {% if active_brand_slugs %}has-active{% endif %}" {% if active_brand_slugs %}open{% endif %}>
      <summary>Бренды</summary>
      <ul class="filter-list">
        {% for f in facet_brands %}
        <li class="filter-item {% if f.active %}active{% endif %}">
          <label>
            <input type="checkbox" class="filter-checkbox" data-group="brands" value="{{ f.slug }}" {% if f.active %}checked{% endif %}>
            <span class="filter-name">{{ f.name }}</span>
            <span class="filter-count">({{ f.count }})</span>
          </label>
        </li>
        {% endfor %}
      </ul>
    </details>

    <details class="filter-group {% if active_tag_slugs %}has-active{% endif %}" {% if active_tag_slugs %}open{% endif %}>
      <summary>Теги</summary>
      <ul class="filter-list">
        {% for f in facet_tags %}
        <li class="filter-item {% if f.active %}active{% endif %}">
          <label>
            <input type="checkbox" class="filter-checkbox" data-group="tags" value="{{ f.slug }}" {% if f.active %}checked{% endif %}>
            <span class="filter-name">#{{ f.name }}</span>
            <span class="filter-count">({{ f.count }})</span>
          </label>
        </li>
        {% endfor %}
      </ul>
    </details>
  </aside>

  <section class="catalog-content">
    <div class="page-header">
      <h1 class="page-title">{{ title }}</h1>
      <div class="group group--sorting">
        <label class="label" for="sort">Сортировка</label>
        <select id="sort" class="select">
          <option value="-created" {% if sort == '-created' %}selected{% endif %}>Сначала новые</option>
          <option value="price" {% if sort == 'price' %}selected{% endif %}>Цена по возрастанию</option>
          <option value="-price" {% if sort == '-price' %}selected{% endif %}>Цена по убыванию</option>
          <option value="name" {% if sort == 'name' %}selected{% endif %}>По названию (А-Я)</option>
        </select>
      </div>
    </div>

    <div class="products-grid">
      {% for product in products %}
      <div class="product-card">
        <a href="{{ product.get_absolute_url }}" class="card-link-overlay" aria-label="Открыть {{ product.name }}"></a>
        {% if product.has_discount %}
        <div class="discount-badge">Скидка</div>
        {% endif %}
        <div class="product-image">
          <img src="{% static "catalog/images/no-image.svg" %}" alt="{{ product.name }}">
        </div>
        <div class="product-info">
          <h3>{{ product.name }}</h3>
          <p class="brand">{{ product.brand.name }}</p>
          <div class="price-section">
            {% if product.has_discount %}
            <span class="old-price">{{ product.old_price }} руб.</span>
            {% endif %}
            <span class="current-price">{{ product.price }} руб.</span>
            {% if product.discount_percent %}
            <span class="current-price">(-{{ product.discount_percent|floatformat:0 }}%)</span>
            {% endif %}
          </div>
          <div class="stock-info">
            {% if product.quantity > 0 %}
            <span class="in-stock">В наличии ({{ product.quantity }})</span>
            {% else %}
            <span class="out-of-stock">Нет в наличии</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% empty %}
      <div class="no-products">
        <p>Товары не найдены</p>
      </div>
      {% endfor %}
    </div>

    <div class="pagination">
      {% if page_obj %}
      <div class="group">
        {% if page_obj.has_previous %}
        <a class="chip" href="?{{ querystring }}&page={{ page_obj.previous_page_number }}">← Предыдущая</a>
        {% endif %}
        <span class="label">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a class="chip" href="?{{ querystring }}&page={{ page_obj.next_page_number }}">Следующая →</a>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <div class="results-counter">
      <span class="label">Найдено:</span>
      <span class="label">{{ page_obj.paginator.count }} товаров</span>
    </div>
  </section>
</div>

<script>
  function getSelected(group) {
    return Array.from(document.querySelectorAll('.filter-checkbox[data-group="' + group + '"]:checked')).map(function(i){return i.value});
  }
  function applyFilters() {
    var params = new URLSearchParams(window.location.search);
    params.delete('category');
    params.delete('brand');
    params.delete('tag');
    var cats = getSelected('categories');
    var brands = getSelected('brands');
    var tags = getSelected('tags');
    if (cats.length) { params.set('categories', cats.join(',')); } else { params.delete('categories'); }
    if (brands.length) { params.set('brands', brands.join(',')); } else { params.delete('brands'); }
    if (tags.length) { params.set('tags', tags.join(',')); } else { params.delete('tags'); }
    var sortSel = document.getElementById('sort');
    if (sortSel && sortSel.value) { params.set('sort', sortSel.value); }
    params.delete('page');
    window.location.search = params.toString();
  }
  document.querySelectorAll('.filter-checkbox').forEach(function(cb){ cb.addEventListener('change', applyFilters); });
  var sortSel = document.getElementById('sort');
  if (sortSel) { sortSel.addEventListener('change', applyFilters); }
</script>
{% endblock %}
