# Лабораторная работа №8 — TechMarket

## Титульный лист
- Дисциплина: Веб‑программирование (Django)
- Тема: Пагинация, расширенный поиск, API без DRF, тестирование
- Студент: Фролова
- Группа: —
- Дата: 2025‑11‑27

## Цель работы
Реализовать все виды связей в БД, добавить теги и обеспечить их вывод на страницах, использовать `Q`, `F`, `Value`, вычисляемые поля, агрегаты и группировку (вычисления на стороне СУБД).

## Задание
- Добавить таблицы и связи между таблицами (все виды: `ForeignKey`, `ManyToMany`, `OneToOne`).
- Добавить на сайт теги и обеспечить вывод информации на страницах с использованием тегов.
- Использовать `Q`, `F`, `Value`, вычисляемые поля, агрегирующие функции, группировку записей и вычисления на стороне СУБД.

## Теоретическая часть
- Связи ORM: типы `ForeignKey`, `ManyToMany`, `OneToOne` и их назначение.
- Теги: концепция меток для классификации/фильтрации и связь `ManyToMany`.
- Расширенные запросы: `Q` для сложных условий, `F`/`Value` для вычислений и констант, аннотации и агрегаты, группировки и вычисления на стороне СУБД.

## Ход работы
1. Инициализация требований
- Зафиксированы три пункта задания: связи, теги, расширенные ORM‑операции.

2. Реализация связей в БД
- Действие: добавлены сущности и связи — `Tag` и поле `Product.tags` (ManyToMany), `ProductDetail` (OneToOne), `Order` и `OrderItem` (ManyToMany через промежуточную модель).
- Ссылки на код: `catalog/models.py:5–15` (Tag), `catalog/models.py:98–99` (Product.tags), `catalog/models.py:132–144` (ProductDetail), `catalog/models.py:146–178` (Order/OrderItem).
- Скриншот (Рис. 1): админка — список моделей Tag, ProductDetail, Order. [Вставить скриншот /admin/]
- Скриншот (Рис. 2): форма заказа — инлайн `OrderItem` с позициями. [Вставить скриншот формы Order]

3. Настройка админ‑интерфейса
- Действие: зарегистрированы новые модели; добавлен инлайн `OrderItem` внутри заказа; включён выбор тегов у товара (виджет на форме продукта).
- Ссылки на код: `catalog/admin.py:17–43` (ProductAdmin с `filter_horizontal` для тегов), `catalog/admin.py:45–63` (TagAdmin, ProductDetailAdmin, OrderAdmin, OrderItemInline).
- Скриншот (Рис. 3): форма продукта — виджет выбора тегов. [Вставить скриншот Product в админке]

4. Добавление тегов на сайт
- Действие: добавлен шаблонный тег `get_tags`; в каталоге — блок «Теги» на следующей строке после «Бренды»; реализована фильтрация по `?tag=…`; в карточке товара отображаются теги.
- Ссылки на код: `catalog/templatetags/catalog_tags.py:10–12` (тег), `catalog/views.py:36–38` (фильтр), `catalog/templates/catalog/product_list.html:20–25` (блок тегов), `catalog/templates/catalog/product_detail.html:54–61` (теги товара).
- Скриншот (Рис. 4): `/catalog/` — панель фильтров с блоками «Бренды» и «Теги». [Вставить скриншот]
- Скриншот (Рис. 5): `/catalog/?tag=hit` — список отфильтрован по тегу. [Вставить скриншот]

5. Расширенные ORM‑операции
- Действие: аннотирован `discount_percent` через `Case/When`, `F`, `Value`; добавлены агрегаты, группировки и аннотирование в `orm_examples`.
- Ссылки на код: `catalog/views.py:49–56` (аннотация скидки), `catalog/views.py:175–195` (агрегаты/группировки/аннотации).
- Скриншот (Рис. 6): `/catalog/` — карточки со старой ценой и процентом скидки. [Вставить скриншот]
- Скриншот (Рис. 7): `/catalog/orm-examples/` — JSON с `price_stats`, `products_by_brand`, `annotated`. [Вставить скриншот]

6. Наполнение базы данных
- Действие: наполнитель создаёт теги, характеристики, назначает теги товарам, добавляет пример заказа.
- Ссылки на код: `catalog/management/commands/fill_database.py` (завершающие блоки).
- Команда: `py -3 manage.py fill_database`.
- Скриншот (Рис. 8): консоль с сообщением «База данных успешно заполнена…». [Вставить скриншот]

7. Тестирование
- Действие: подготовлены модульные тесты — фильтр по тегам, наличие характеристик, агрегат по заказу.
- Ссылки на код: `catalog/tests.py`.
- Команда: `py -3 manage.py test -v 2`.
- Скриншот (Рис. 9): консоль с результатами тестов `OK`. [Вставить скриншот]

8. Верификация интерфейса
- Действие: проверено отображение тегов, характеристик, процента скидки; карточки похожих товаров; кликабельность карточек в каталоге.
- Ссылки на код: `catalog/templates/catalog/product_detail.html:43–61, 73–83` (характеристики, теги, похожие), `catalog/templates/catalog/product_list.html:41–52` (оверлей‑ссылка на карточке).
- Скриншот (Рис. 10): карточка товара — блоки «Характеристики», «Теги», «Похожие товары». [Вставить скриншот]
- Скриншот (Рис. 11): каталог — кликабельная карточка ведёт на страницу товара. [Вставить скриншот]

## Практическая часть
### Новые модели и связи
- `Tag` и `Product.tags` (ManyToMany) — catalog/models.py:1–20; 82–84.
- `ProductDetail` (OneToOne) — catalog/models.py:115–130.
- `Order` и `OrderItem` (ManyToMany через промежуточную модель) — catalog/models.py:131–164.
### Теги и интерфейс
- Вывод тегов в списке и карточке товара — catalog/templates/catalog/product_list.html:15–21, 47–53; catalog/templates/catalog/product_detail.html:42–55.
- Шаблонный тег `get_tags` — catalog/templatetags/catalog_tags.py:10–12.
### Расширенные ORM‑операции
- Каталог: аннотация `discount_percent` через `Case/When`, `F` и `Value` (catalog/views.py:10–48).
- Демонстрации в `orm_examples`: сложные условия `Q`, агрегаты и группировки, вычисляемые поля/аннотации (catalog/views.py:118–173 с дополнениями).
### Несоответствия
- Удалены упоминания поля `image` в админке и шаблоне — catalog/admin.py:26–43; catalog/templates/catalog/product_detail.html:5–12.
- Исправлён `legacy_redirect` — catalog/views.py:114–116.
- Импортирован `Q` и локаль/часовой пояс обновлены — catalog/models.py:1–2; techmarket/settings.py:107–110.

## Дополнительные улучшения
- Пагинация каталога и API: `display_products` и `product_list_api` поддерживают `page`/`page_size`; добавлена навигация и счётчик результатов в шаблоне (catalog/views.py:10–48; 214–231; catalog/templates/catalog/product_list.html:31–32, 74–89).
- Учебный API CRUD: `POST`/`PUT`/`DELETE` для товаров (catalog/views.py:175–231).
 - Место для скриншота (пагинация): страница каталога со второй страницей.
 - Что должно быть видно: блок навигации «Предыдущая/Следующая» и счётчик «Найдено» под сеткой.
 - Место для скриншота (API): браузер/инструмент для запросов на `/catalog/api/products/?page=1&page_size=5`.
 - Что должно быть видно: JSON с полями `results`, `page`, `pages`, `count`.

## Тестирование
- Всего тестов: 11 (каталог, теги/детали, заказы; дополнительные тесты покрывают пагинацию и API).
- Запуск: `py -3 manage.py test -v 2`.
- Результат: все тесты прошли успешно.

## Примечание
Отчёт отражает последовательный ход работ по трём обязательным пунктам ЛР8; дополнительные улучшения (пагинация и учебный API CRUD) вынесены отдельно.

## Приложения
- Ключевые фрагменты кода с привязкой к файлам:
  - `display_products`: catalog/views.py:10–48
  - `product_list_api`: catalog/views.py:175–231
  - `product_detail_api`: catalog/views.py:184–231
  - Админка: catalog/admin.py:17–43
  - Шаблоны: catalog/templates/catalog/product_list.html, product_detail.html

### Приложение B: ссылки на код и фрагменты
- Модели и связи:
  - `Tag` (ManyToMany): catalog/models.py:5–15, 98–99
  - `ProductDetail` (OneToOne): catalog/models.py:132–144
  - `Order`/`OrderItem` (ManyToMany через промежуточную): catalog/models.py:146–178
```
# catalog/models.py (фрагменты)
class Tag(models.Model):
    name = models.CharField(max_length=50, unique=True, verbose_name="Название")
    slug = models.SlugField(max_length=60, unique=True, db_index=True, verbose_name="URL")

class Product(models.Model):
    # ...
    tags = models.ManyToManyField('Tag', related_name='products', blank=True, verbose_name="Теги")

class ProductDetail(models.Model):
    product = models.OneToOneField(Product, on_delete=models.CASCADE, related_name='details', verbose_name="Товар")
    sku = models.CharField(max_length=100, verbose_name="Артикул")
    warranty_months = models.IntegerField(default=12, verbose_name="Гарантия (мес)")

class Order(models.Model):
    products = models.ManyToManyField(Product, through='OrderItem', related_name='orders', verbose_name="Товары")

class OrderItem(models.Model):
    order = models.ForeignKey(Order, on_delete=models.CASCADE, related_name='items', verbose_name="Заказ")
    product = models.ForeignKey(Product, on_delete=models.PROTECT, related_name='order_items', verbose_name="Товар")
```

- Теги в шаблонах и шаблонный тег:
  - `get_tags`: catalog/templatetags/catalog_tags.py:10–12
  - Вывод тегов: catalog/templates/catalog/product_list.html:15–21, 47–53; catalog/templates/catalog/product_detail.html:42–55
```
# catalog/templatetags/catalog_tags.py
@register.simple_tag
def get_tags():
    return Tag.objects.all()
```

- Фильтр по тегу и вычисляемые поля (`Q`, `F`, `Value`, `Case/When`):
  - catalog/views.py:36–38 (фильтр тегов), 49–56 (аннотации discount_percent, source_label)
```
# catalog/views.py (фрагменты)
if tag_slug:
    products = products.filter(tags__slug=tag_slug)

products = products.annotate(
    discount_percent=Case(
        When(old_price__gt=F('price'), then=(F('old_price') - F('price')) * 100.0 / F('old_price')),
        default=Value(0.0),
        output_field=FloatField()
    ),
    source_label=Value('Каталог', output_field=CharField())
)
```

- ORM-демонстрации (агрегаты/группировки/аннотации):
  - catalog/views.py:175–185 (агрегаты и группировки), 188–195 (аннотирование)
```
# catalog/views.py (фрагменты orm_examples)
price_stats = Product.objects.aggregate(
    avg_price=Avg('price'), total_products=Count('id'), total_value=Sum('price')
)
products_by_brand = Product.objects.values('brand__name').annotate(
    count=Count('id'), avg_price=Avg('price')
)
annotated = Product.objects.annotate(
    discount_percent=Case(
        When(old_price__gt=F('price'), then=(F('old_price') - F('price')) * 100.0 / F('old_price')),
        default=Value(0.0), output_field=FloatField()
    ),
    label=Value('ORM demo', output_field=models.CharField())
)
```

- Админка новых сущностей:
  - catalog/admin.py:26–43 (ProductAdmin), 45–63 (TagAdmin, ProductDetailAdmin, OrderAdmin, OrderItemInline)
```
# catalog/admin.py (фрагменты)
@admin.register(Tag)
class TagAdmin(admin.ModelAdmin):
    list_display = ['name', 'slug']

class OrderItemInline(admin.TabularInline):
    model = OrderItem

@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    inlines = [OrderItemInline]
```

- Наполнитель данных: теги, характеристики и заказ:
  - catalog/management/commands/fill_database.py:1–134 (основа), дополнения: присвоение тегов/деталей и заказов (новые блоки в конце)
```
# catalog/management/commands/fill_database.py (фрагменты)
for t in ['Хит', 'Новинка', 'Распродажа', 'Игровой', 'Премиум']:
    Tag.objects.get_or_create(name=t, defaults={'slug': slugify(t)})

for product in Product.objects.all():
    ProductDetail.objects.get_or_create(product=product, defaults={
        'sku': f'SKU-{product.id:05d}', 'warranty_months': 12, 'specs': 'Стандартные характеристики'
    })
    for tag in Tag.objects.order_by('?')[:2]:
        product.tags.add(tag)

order = Order.objects.get_or_create(code='ORD-0001', defaults={'status': Order.Status.NEW})[0]
for product in Product.objects.all()[:3]:
    OrderItem.objects.get_or_create(order=order, product=product, defaults={'quantity': 1, 'price': product.price})
```
